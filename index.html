<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NWRTW Contact Portal — Change & Save • v1.0.6 (log-only)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#f7fafc; --card:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --accent:#2563eb; --accent-2:#059669; --danger:#dc2626;
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; }
    header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:12px; background:#fff; position:sticky; top:0; z-index:10; }
    .brand { font-weight:700; letter-spacing:.2px; }
    .meta { font-size:12px; color:var(--muted); }
    main { max-width:980px; margin:24px auto 64px; padding:0 16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 1px 2px rgba(0,0,0,.04); padding:18px; }
    .h { font-weight:700; margin:0 0 12px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .row-1 { display:grid; grid-template-columns: 1fr; gap:12px; }
    label { font-size:12px; color:var(--muted); display:block; margin:0 0 6px; }
    input[type="text"], select, input[type="search"] {
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; color:var(--text);
      outline:none; transition:border .12s ease, box-shadow .12s ease;
    }
    input:focus, select:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.12); }
    .actions { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    button {
      appearance:none; border:1px solid var(--accent); background:var(--accent); color:#fff; border-radius:10px;
      padding:10px 14px; font-weight:600; cursor:pointer; transition:filter .12s ease, transform .02s ease;
    }
    button.secondary { background:#fff; color:var(--accent); }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .stat { font-size:12px; color:var(--muted); }
    .pill { display:inline-flex; align-items:center; gap:8px; background:#f1f5f9; border:1px solid var(--border); padding:6px 8px; border-radius:999px; }
    .ok { color:var(--accent-2); }
    .err { color:var(--danger); }
    pre#debugOut { display:none; background:#0b1020; color:#e5e7eb; padding:12px; border-radius:12px; max-height:320px; overflow:auto; border:1px solid #0f172a; }
    .grid-gap { height:16px; }
    @media (max-width: 760px) {
      .row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="brand">NWRTW Contact Portal</div>
      <div class="meta">Change & Save • v1.0.6 (log-only)</div>
    </div>
    <div class="meta">
      <span class="pill">User: <strong id="userName">Unknown</strong></span>
    </div>
  </header>

  <main>
    <!-- SEARCH -->
    <section class="card" id="searchCard">
      <h3 class="h">Search Contact</h3>
      <div class="row">
        <div>
          <label for="search_first">First Name</label>
          <input id="search_first" type="search" placeholder="e.g., 0004444" />
        </div>
        <div>
          <label for="search_last">Last Name</label>
          <input id="search_last" type="search" placeholder="e.g., MT001" />
        </div>
      </div>
      <div class="grid-gap"></div>
      <div class="actions">
        <button id="findBtn">Find</button>
        <span id="findStat" class="stat"></span>
      </div>
    </section>

    <div class="grid-gap"></div>

    <!-- DETAILS (hidden until a contact is loaded) -->
    <section class="card" id="detailsCard" style="display:none;">
      <h3 class="h">Contact Details</h3>
      <div class="row">
        <div>
          <label for="first_name">First Name</label>
          <input id="first_name" type="text" placeholder="e.g., 0004444" />
        </div>
        <div>
          <label for="last_name">Last Name</label>
          <input id="last_name" type="text" placeholder="e.g., MT001" />
        </div>
      </div>
      <div class="grid-gap"></div>
      <div class="row">
        <div>
          <label for="status">Status (GHL custom field)</label>
          <input id="status" type="text" placeholder="e.g., IE Authorized" />
        </div>
        <div>
          <label for="ghl_id">GHL Contact ID</label>
          <input id="ghl_id" type="text" placeholder="Loaded from search…" disabled />
        </div>
      </div>
      <div class="grid-gap"></div>
      <div class="actions">
        <button id="saveBtn" disabled>Save (log-only)</button>
        <button id="resetBtn" class="secondary">Reset</button>
        <label class="pill" style="cursor:pointer;">
          <input type="checkbox" id="debugToggle" /> Debug
        </label>
        <span id="saveStat" class="stat"></span>
      </div>
      <div class="grid-gap"></div>
      <pre id="debugOut"></pre>
    </section>
  </main>

  <script type="module">
    /* =======================
       USER from URL (required for Save only)
    ======================= */
    const USER_PARAM_KEYS = ['user','u','name'];
    function getUserFromUrl() {
      const p = new URLSearchParams(location.search);
      for (const k of USER_PARAM_KEYS) {
        const v = p.get(k);
        if (v && v.trim()) return v.trim();
      }
      return null;
    }
    const USER = getUserFromUrl();
    document.querySelector('#userName').textContent = USER || 'Missing user';

    /* =======================
       CONFIG
    ======================= */
    const ENDPOINT_FIND = '/nwrtw-find-contact';     // existing find worker
    const ENDPOINT_SAVE = '/nwrtw-contact-change';   // new save worker (v1.0)

    /* =======================
       STATE
    ======================= */
    const state = { ghl_contact_id: null, loadedContact: null };

    /* =======================
       DOM
    ======================= */
    const $ = (sel) => document.querySelector(sel);
    const findBtn   = $('#findBtn');
    const findStat  = $('#findStat');
    const saveBtn   = $('#saveBtn');
    const saveStat  = $('#saveStat');
    const resetBtn  = $('#resetBtn');
    const dbgToggle = $('#debugToggle');
    const dbgOut    = $('#debugOut');
    const detailsCard = $('#detailsCard');

    const inpSearchFirst = $('#search_first');
    const inpSearchLast  = $('#search_last');

    const inpFirst = $('#first_name');
    const inpLast  = $('#last_name');
    const inpStat  = $('#status');
    const inpGhlId = $('#ghl_id');

    // start hidden/disabled
    detailsCard.style.display = 'none';
    saveBtn.disabled = true;

    /* =======================
       HELPERS
    ======================= */
    function setStatus(el, msg, isErr = false) {
      if (!el) return;
      el.textContent = msg || '';
      el.classList.toggle('err', !!isErr);
      el.classList.toggle('ok', !isErr && !!msg);
      if (msg && !isErr) setTimeout(() => { el.textContent = ''; el.classList.remove('ok','err'); }, 2500);
    }
    function showDebug(obj) {
      if (!dbgToggle?.checked) {
        dbgOut.style.display = 'none';
        dbgOut.textContent = '';
        return;
      }
      dbgOut.style.display = 'block';
      dbgOut.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    }
    function fillContact(contact) {
      state.loadedContact = contact || null;
      state.ghl_contact_id = contact?.ghl_contact_id || null;

      if (state.ghl_contact_id) {
        detailsCard.style.display = 'block';
        saveBtn.disabled = false;
      } else {
        detailsCard.style.display = 'none';
        saveBtn.disabled = true;
      }

      inpGhlId.value = state.ghl_contact_id || '';
      inpFirst.value = contact?.first_name ?? '';
      inpLast.value  = contact?.last_name ?? '';
      inpStat.value  = contact?.status ?? '';
    }
    function resetForm() {
      fillContact(null);
      inpSearchFirst.value = '';
      inpSearchLast.value  = '';
      showDebug('');
    }

    // Expose for existing code (no-op if unused)
    window.nwrtwSetLoadedContact = function(contact) { fillContact(contact); };

/* =======================
   FIND CONTACT — compatible with old worker
   - Sends BOTH {first_name,last_name} and {first,last}
   - Accepts common response shapes
   - Shows raw server reply when shape mismatches
======================= */
async function doFind() {
  const first = (inpSearchFirst.value || '').trim();
  const last  = (inpSearchLast.value  || '').trim();

  if (!first || !last) {
    setStatus(findStat, 'Enter both First and Last.', true);
    fillContact(null);
    return;
  }

  setStatus(findStat, 'Searching…');
  findBtn.disabled = true;

  // helper: safely parse JSON or return raw text
  const readSafe = async (res) => {
    const txt = await res.text();
    try { return { body: JSON.parse(txt), raw: null, status: res.status, ok: res.ok }; }
    catch { return { body: null, raw: txt, status: res.status, ok: res.ok }; }
  };

  try {
    // Send BOTH key styles to satisfy older/newer workers
    const res = await fetch(ENDPOINT_FIND, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        first_name: first,
        last_name:  last,
        first,
        last
      })
    });

    const out = await readSafe(res);
    if (dbgToggle?.checked) showDebug(out.body ?? { status: out.status, raw: out.raw });

    // Accept any of these shapes:
    // { ok:true, contact:{...} }
    // { contact:{...} }
    // { data:{ contact:{...} } }
    // { data:[ {...} ] }
    // [ {...} ]
    let contact = null;
    const b = out.body;

    if (b?.contact) contact = b.contact;
    else if (b?.data?.contact) contact = b.data.contact;
    else if (Array.isArray(b?.data) && b.data.length) contact = b.data[0];
    else if (Array.isArray(b) && b.length) contact = b[0];

    if (!out.ok || !contact) {
      const msg = (b && (b.error || b.message)) || (out.raw ? `Server: ${out.raw}` : 'Contact not found');
      setStatus(findStat, msg, true);
      fillContact(null);
      return;
    }

    // Normalize expected fields if worker names differ
    contact = {
      ghl_contact_id: contact.ghl_contact_id ?? contact.ghlId ?? contact.contact_id ?? contact.id ?? null,
      first_name:     contact.first_name ?? contact.firstName ?? null,
      last_name:      contact.last_name  ?? contact.lastName  ?? null,
      status:         contact.status ?? contact.current_status ?? null,
      ...contact
    };

    fillContact(contact);
    setStatus(findStat, 'Loaded.');
  } catch (e) {
    setStatus(findStat, `Search error: ${String(e?.message || e)}`, true);
    fillContact(null);
    if (dbgToggle?.checked) showDebug(String(e?.message || e));
  } finally {
    findBtn.disabled = false;
  }
}

    /* =======================
       SAVE (log + upsert only)
       requires USER in URL
    ======================= */
    async function doSave() {
      if (!USER) {
        setStatus(saveStat, 'Missing ?user= in URL (or ?u=/ ?name=).', true);
        return;
      }
      if (!state.ghl_contact_id) {
        setStatus(saveStat, 'No contact loaded.', true);
        return;
      }

      const payload = {
        actor: USER,
        ghl_contact_id: state.ghl_contact_id,
        status: (inpStat.value || '').trim() || null,
        fields: {
          first_name: (inpFirst.value || '').trim() || null,
          last_name:  (inpLast.value  || '').trim() || null,
        },
        debug: !!(dbgToggle && dbgToggle.checked)
      };

      try {
        setStatus(saveStat, 'Saving…');
        saveBtn.disabled = true;

        const res = await fetch(ENDPOINT_SAVE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const txt = await res.text();
        let json; try { json = JSON.parse(txt); } catch { json = { raw: txt }; }

        if (!res.ok || !json?.ok) {
          setStatus(saveStat, 'Save error', true);
          if (dbgToggle?.checked) showDebug(json);
          return;
        }
        setStatus(saveStat, 'Saved.');
        if (dbgToggle?.checked) showDebug(json);
      } catch (e) {
        setStatus(saveStat, 'Save error', true);
        if (dbgToggle?.checked) showDebug(String(e?.message || e));
      } finally {
        saveBtn.disabled = !state.ghl_contact_id;
      }
    }

    /* =======================
       WIRE UP
    ======================= */
    findBtn.addEventListener('click', doFind);
    saveBtn.addEventListener('click', doSave);
    resetBtn.addEventListener('click', resetForm);
    dbgToggle?.addEventListener('change', () =>
      showDebug(state.loadedContact ? { loaded: state.loadedContact } : '')
    );
  </script>
</body>
</html>
