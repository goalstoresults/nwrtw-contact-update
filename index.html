<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NWRTW – Contact Update Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }

    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; background: #f7f7f8; color: #111827; }
    header { padding: 16px 20px; background: #111827; color: #fff; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .hdr-left { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .user-badge { background:#0ea5e9; color:#fff; padding:6px 10px; border-radius:999px; font-size:12px; }
    main { padding: 20px; max-width: 960px; margin: 0 auto; }
    .ver { font-size: 12px; color: #d1d5db; }
    .card { background: #fff; border-radius: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); padding: 16px; margin-bottom: 16px; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    @media (max-width: 720px) { .row, .row-3 { grid-template-columns: 1fr; } }

    label { font-size: 12px; color: #374151; display: block; margin-bottom: 6px; }
    input, select, button {
      display: block; width: 100%; padding: 10px 12px;
      border-radius: 10px; border: 1px solid #d1d5db; background: #fff; font-size: 14px;
    }
    input[readonly] { background: #f3f4f6; color: #6b7280; }
    button { background: #111827; color: #fff; border: none; cursor: pointer; }
    button.secondary { background: #e5e7eb; color: #111827; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .toolbar { display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }
    .toolbar button { width: auto; }

    .statusbar { margin-top: 8px; font-size: 13px; }
    .status-ok { color: #065f46; }
    .status-err { color: #991b1b; }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 8px 10px; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
    th { font-size: 12px; letter-spacing: .02em; color: #374151; text-transform: uppercase; }
    .results-list { margin-top: 8px; }
    .result-item { padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; background:#fff; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#eef2ff; color:#3730a3; font-size:12px; }
    footer { padding: 12px 20px; text-align:center; color:#6b7280; font-size:12px; }
  </style>
</head>
<body>
  <header>
    <div class="hdr-left">
      <strong>NWRTW – Contact Update Portal</strong>
      <span class="user-badge" id="userBadge">User: (unknown)</span>
    </div>
    <span class="ver" id="versionTxt">v0.1.9 • 2025-10-31</span>
  </header>

  <main>
    <!-- FIND -->
    <section class="card">
      <h3>Find Contact</h3>
      <div class="row">
        <div>
          <label for="firstName">First Name</label>
          <input id="firstName" placeholder="e.g., 00004321" autocomplete="off"/>
        </div>
        <div>
          <label for="lastName">Last Name</label>
          <input id="lastName" placeholder="e.g., PT001" autocomplete="off"/>
        </div>
      </div>
      <div class="toolbar" style="margin-top:12px;">
        <button id="findBtn">Find</button>
      </div>
      <div id="findMsg" class="statusbar"></div>
      <div id="results" class="results-list"></div>
    </section>

    <!-- CONTACT DETAILS -->
    <section class="card" id="contactCard" style="display:none;">
      <h3>Contact</h3>
      <div class="row">
        <div>
          <label>Active</label>
          <input id="activeYn" readonly />
        </div>
        <div>
          <label>Program</label>
          <input id="program" readonly />
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div>
          <label>Status</label>
          <select id="statusSelect"></select>
        </div>
        <div>
          <label>Current Status</label>
          <input id="currentStatus" readonly />
        </div>
      </div>

      <!-- NEW date fields (start blank) -->
      <div class="row" style="margin-top:12px;">
        <div>
          <label for="authStart">Auth Start</label>
          <input id="authStart" type="date" autocomplete="off" />
        </div>
        <div>
          <label for="authEnd">Auth End</label>
          <input id="authEnd" type="date" autocomplete="off" />
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <div>
          <label for="txStart">TX Start</label>
          <input id="txStart" type="date" autocomplete="off" />
        </div>
        <div>
          <label for="txEnd">TX End</label>
          <input id="txEnd" type="date" autocomplete="off" />
        </div>
      </div>

      <div class="toolbar" style="margin-top:12px;">
        <button id="saveBtn">Save</button>
        <button class="secondary" id="clearBtn">Clear</button>
      </div>
      <div id="saveMsg" class="statusbar"></div>
    </section>

    <!-- HISTORY -->
    <section class="card" id="historyCard" style="display:none;">
      <h3>Change History</h3>
      <table>
        <thead>
          <tr>
            <th>User Name</th>
            <th>Change Date (LA)</th>
            <th>Status</th>
            <th>Program</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </section>
  </main>

  <footer>
    NWRTW Contact Update • <span id="verFooter">v0.1.8 • 2025-10-31</span>
  </footer>

  <script>
    // ======== CONFIG ========
    const VERSION = "v0.1.8 • 2025-10-31";
    const API_BASE = "https://nwrtw-find-contact.dennis-e64.workers.dev";        // find & load
    const SAVE_ENDPOINT = "https://nwrtw-contact-change.dennis-e64.workers.dev";  // save
    const STATUS_OPTIONS = [
      "RX Received","On Hold","RX Processed","IE Authorized","IE Scheduled",
      "IE Completed","On Hold Review","TX Authorized","TX Scheduled",
      "Active Treatment","Follow Up","Discharged"
    ];

    document.getElementById("versionTxt").textContent = VERSION;
    document.getElementById("verFooter").textContent = VERSION;

    // ======== USER NAME HANDOFF ========
    function getQueryParam(name){ const u=new URL(window.location.href); return u.searchParams.get(name); }
    const qpUser = getQueryParam("user_name");
    if (qpUser) sessionStorage.setItem("nwrtw_user_name", qpUser);
    function getUserNameOrDie(){
      let u = sessionStorage.getItem("nwrtw_user_name");
      if (!u) { const qp = getQueryParam("user_name"); if (qp) { sessionStorage.setItem("nwrtw_user_name", qp); u = qp; } }
      return (u || "").trim();
    }
    const userName = getUserNameOrDie();
    document.getElementById("userBadge").textContent = `User: ${userName || "(unknown)"}`;

    // ======== UTIL ========
    const $ = (id) => document.getElementById(id);
    const setStatus = (el, msg, ok=true) => { el.textContent = msg; el.className = "statusbar " + (ok ? "status-ok" : "status-err"); };
    function formatDateLocal(isoLike){
      if (!isoLike) return "";
      try {
        const parts = isoLike.split(/[T ]/);
        if (parts.length >= 2) return parts[0] + " " + parts[1].slice(0,8);
        return isoLike;
      } catch { return isoLike; }
    }
    function uniqueOptions(select, values, current){
      const set=new Set(values); if (current && !set.has(current)) set.add(current);
      const arr=[...set]; select.innerHTML="";
      for (const v of arr){ const opt=document.createElement("option"); opt.value=v; opt.textContent=v; select.appendChild(opt); }
      if (current) select.value=current;
    }

    // Always start blank, then set if a valid value exists
    function setDateInput(id, val){
      const el = document.getElementById(id);
      if (!el) return;
      el.value = '';                         // force blank default (prevents autofill)
      if (!val) return;

      const s = String(val);
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {   // already date-only
        el.value = s;
        return;
      }
      const d = new Date(s);
      if (!isNaN(d)){
        const yyyy = d.getUTCFullYear();
        const mm = String(d.getUTCMonth()+1).padStart(2,'0');
        const dd = String(d.getUTCDate()).padStart(2,'0');
        el.value = `${yyyy}-${mm}-${dd}`;
      }
    }
    const getDateOrNull = (id) => { const v = (document.getElementById(id)?.value || '').trim(); return v ? v : null; };

    // ======== STATE ========
    let currentContact = null;

    // ======== FIND ========
    $("findBtn").addEventListener("click", async () => {
      const first_name = $("firstName").value.trim();
      const last_name  = $("lastName").value.trim();
      $("results").innerHTML = "";
      setStatus($("findMsg"), "Searching…", true);

      try {
        const r = await fetch(`${API_BASE}/find`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ first_name, last_name })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || "Search failed");

        if (data.count === 0) {
          setStatus($("findMsg"), "Contact not found.", false);
          $("contactCard").style.display = "none";
          $("historyCard").style.display = "none";
          return;
        }

        setStatus($("findMsg"), `Found ${data.count} contact(s).`, true);

        if (data.count === 1) {
          renderContact(data.matches[0]);
          renderHistory(data.history || []);
        } else {
          const container = $("results");
          data.matches.forEach(item => {
            const div = document.createElement("div");
            div.className = "result-item";
            div.innerHTML = `
              <div>
                <div><strong>${item.first_name || ""} ${item.last_name || ""}</strong></div>
                <div class="muted">Program: ${item.program || ""}</div>
              </div>
              <div><span class="pill">${item.status || "—"}</span></div>`;
            div.addEventListener("click", () => loadContact(item.ghl_contact_id));
            container.appendChild(div);
          });
        }
      } catch (e) {
        setStatus($("findMsg"), e.message || "Error searching.", false);
      }
    });

    async function loadContact(ghl_contact_id){
      $("results").innerHTML = "";
      $("contactCard").style.display = "none";
      $("historyCard").style.display = "none";
      setStatus($("findMsg"), "Loading contact…", true);
      try {
        const r = await fetch(`${API_BASE}/contact?ghl_contact_id=${encodeURIComponent(ghl_contact_id)}`);
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || "Load failed");
        renderContact(data.contact);
        renderHistory(data.history || []);
        setStatus($("findMsg"), "Loaded.", true);
      } catch (e) {
        setStatus($("findMsg"), e.message || "Error loading contact.", false);
      }
    }

    function renderContact(contact){
      currentContact = contact;
      $("contactCard").style.display = "";
      $("activeYn").value = contact.active_yn ?? "";
      $("program").value = contact.program || "";
      $("currentStatus").value = contact.status || "";

      uniqueOptions($("statusSelect"), STATUS_OPTIONS, contact.status || "");

      // Clear then set date inputs from response (keeps blank default when null)
      ["authStart","authEnd","txStart","txEnd"].forEach(id => { const el=$(id); if (el) el.value=''; });
      setDateInput("authStart", contact.auth_start || null);
      setDateInput("authEnd",   contact.auth_end   || null);
      setDateInput("txStart",   contact.tx_start   || null);
      setDateInput("txEnd",     contact.tx_end     || null);

      $("saveMsg").textContent = "";
      $("historyCard").style.display = "none";
    }

    function renderHistory(list){
      $("historyCard").style.display = "";
      const tbody = $("historyBody"); tbody.innerHTML = "";
      list.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.user_name || ""}</td>
          <td>${formatDateLocal(row.change_date)}</td>
          <td>${row.status || ""}</td>
          <td>${row.program || ""}</td>`;
        tbody.appendChild(tr);
      });
    }

    // ======== SAVE ========
    $("saveBtn").addEventListener("click", async () => {
      if (!currentContact) return;

      const actingUser = getUserNameOrDie();
      if (!actingUser) {
        setStatus($("saveMsg"), "Missing user_name. Open this page with ?user_name=…", false);
        return;
      }

      const payload = {
        ghl_contact_id: currentContact.ghl_contact_id,
        status: $("statusSelect").value,
        user_name: actingUser,
        // NEW date fields (send null if blank)
        auth_start: getDateOrNull("authStart"),
        auth_end:   getDateOrNull("authEnd"),
        tx_start:   getDateOrNull("txStart"),
        tx_end:     getDateOrNull("txEnd"),
      };

      const saveUrl = `${SAVE_ENDPOINT}?user_name=${encodeURIComponent(actingUser)}`;

      $("saveBtn").disabled = true;
      setStatus($("saveMsg"), "Saving…", true);

      try {
        const r = await fetch(saveUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-acting-user": actingUser
          },
          body: JSON.stringify(payload)
        });
        const txt = await r.text();
        let data; try { data = JSON.parse(txt); } catch { data = { raw: txt }; }

        if (!r.ok || data?.ok === false) {
          const msg = data?.error || `HTTP ${r.status}: ${data?.raw || "Save failed"}`;
          setStatus($("saveMsg"), msg, false);
          return;
        }

        await loadContact(currentContact.ghl_contact_id);
        setStatus($("saveMsg"), "Saved ✓", true);
      } catch (e) {
        setStatus($("saveMsg"), String(e?.message || e) || "Error saving.", false);
      } finally {
        $("saveBtn").disabled = false;
      }
    });

    $("clearBtn").addEventListener("click", () => {
      currentContact = null;
      ["firstName","lastName"].forEach(id => $(id).value = "");
      $("results").innerHTML = "";
      $("contactCard").style.display = "none";
      $("historyCard").style.display = "none";
      $("findMsg").textContent = "";
      $("saveMsg").textContent = "";
      ["authStart","authEnd","txStart","txEnd"].forEach(id => { const el=$(id); if (el) el.value=''; });
    });

    // Optional: auto-load if a contactId is passed in the URL
    const qpId = getQueryParam("ghl_contact_id");
    if (qpId) loadContact(qpId);
  </script>
</body>
</html>
